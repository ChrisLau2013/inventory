<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inventory Counting</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; padding:0; }
header { background:#1e90ff; color:#fff; text-align:center; padding:14px; font-size:20px; position:sticky; top:0; }
main { padding:14px; }

input, select, button { width:100%; font-size:18px; padding:10px; margin-bottom:12px; border-radius:6px; box-sizing:border-box; }
button { background:#1e90ff; color:#fff; border:none; }
button.secondary { background:#666; }
.hidden { display:none; }

#history { max-height:260px; overflow:auto; border-top:1px solid #ccc; }
table { width:100%; border-collapse:collapse; font-size:13px; }
th,td { border:1px solid #ccc; padding:5px; text-align:center; }
thead th { position:sticky; top:0; background:#eee; }

.lock-btn { width:100%; font-size:16px; padding:12px; border-radius:8px; background:#ccc; color:#333; }
.lock-btn.locked { background:#28a745; color:#fff; }
.lock-btn.disabled { background:#ddd; color:#777; }

.temp-tag { color:#ff5722; font-weight:600; }

#toast { position:fixed; bottom:28px; left:50%; transform:translateX(-50%) translateY(20px); padding:14px 18px; border-radius:14px; font-size:15px; color:#fff; opacity:0; pointer-events:none; transition:.35s; }
#toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
#toast.success { background:#28a745; }
#toast.warn { background:#ff9800; }
</style>
</head>

<body>

<header>Inventory Counting</header>

<main>

<!-- CSV -->
<button id="fileBtn">Choose CSV File</button>
<div id="fileName">No file chosen</div>
<input type="file" id="fileInput" accept=".csv" hidden>

<!-- Location -->
<select id="locationSelect">
  <option value="">Select location</option>
  <option>Warehouse Shifts near loading bay</option>
  <option>Warehouse Shifts near Boiler</option>
  <option>Warehouse Shifts close cooler wall</option>
  <option>Warehouse Middle Shifts</option>
  <option>Warehouse Shifts at flour mixer room hallway</option>
  <option>Loading Bay 1</option>
  <option>Loading Bay 2</option>
  <option>Loading Bay 3</option>
  <option>Loading Bay 4</option>
  <option>Loading Bay 5</option>
  <option>Loading Bay 6</option>
</select>

<button type="button" id="lockLocationBtn" class="lock-btn disabled">üîì Location Unlocked</button>

<!-- Category / Search / Product -->
<select id="catalogSelect"><option value="">All Categories</option></select>
<input id="search" placeholder="Search product">
<select id="productSelect"><option value="">Select product</option></select>

<!-- Quantity -->
<input id="qtyInput" type="number" inputmode="numeric" placeholder="Enter quantity">
<button id="saveBtn">Save Count</button>

<!-- Manual Temporary -->
<button class="secondary" id="manualBtn">‚ûï Manual Count</button>
<div id="manualPanel" class="hidden">
  <hr>
  <h3>Manual Inventory Entry (Temporary)</h3>
  <select id="manualCategory"></select>
  <input id="manualSupplier" placeholder="Supplier">
  <input id="manualProduct" placeholder="Product name">
  <input id="manualUnit" placeholder="Unit">
  <input id="manualQty" type="number" placeholder="Quantity">
  <button id="manualSaveBtn">Save Manual Count</button>
</div>

<hr>
<button class="secondary" id="exportBtn">Export CSV</button>

<!-- History -->
<div id="history">
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Location</th>
        <th>Category</th>
        <th>Supplier</th>
        <th>Product</th>
        <th>Unit</th>
        <th>Qty</th>
        <th>Type</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

</main>

<div id="toast" class="success">Saved</div>

<script>
/* Haptic */
function haptic(t='light'){ if(navigator.vibrate) navigator.vibrate(t==='medium'?20:10); }

/* Data */
let data = JSON.parse(localStorage.getItem('inventory')) || { catalogs: [] };
let locationLocked = false;

/* Elements */
const locationSelect=document.getElementById('locationSelect');
const lockBtn=document.getElementById('lockLocationBtn');
const qtyInput=document.getElementById('qtyInput');
const productSelect=document.getElementById('productSelect');
const catalogSelect=document.getElementById('catalogSelect');
const search=document.getElementById('search');
const historyBody=document.getElementById('historyBody');

const manualBtn=document.getElementById('manualBtn');
const manualPanel=document.getElementById('manualPanel');
const manualCategory=document.getElementById('manualCategory');
const manualSupplier=document.getElementById('manualSupplier');
const manualProduct=document.getElementById('manualProduct');
const manualUnit=document.getElementById('manualUnit');
const manualQty=document.getElementById('manualQty');
const manualSaveBtn=document.getElementById('manualSaveBtn');

const fileBtn=document.getElementById('fileBtn');
const fileInput=document.getElementById('fileInput');
const fileName=document.getElementById('fileName');
const exportBtn=document.getElementById('exportBtn');

/* Toast */
function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className=type+' show';
  setTimeout(()=>t.classList.remove('show'),2000);
}

/* Location Lock */
lockBtn.onclick=()=>{
  if(!locationSelect.value) return;
  locationLocked=!locationLocked;
  lockBtn.className='lock-btn'+(locationLocked?' locked':'');
  lockBtn.textContent=locationLocked?'üîí Location Locked':'üîì Location Unlocked';
};

/* Save regular */
document.getElementById('saveBtn').onclick=()=>{
  if(!productSelect.value || !locationSelect.value) return showToast('Missing','warn');
  const qty=parseInt(qtyInput.value);
  if(isNaN(qty)) return;

  const [ci,pi,ki]=productSelect.value.split('-');
  data.catalogs[ci].products[pi].packages[ki].records.push({
    qty, location: locationSelect.value, time: new Date().toISOString()
  });

  localStorage.setItem('inventory', JSON.stringify(data));
  qtyInput.value='';
  if(!locationLocked) locationSelect.value='';
  refresh();
  showToast('Saved');
};

/* Manual Temporary */
manualBtn.onclick=()=>{
  manualPanel.classList.toggle('hidden');
  manualCategory.innerHTML='';
  data.catalogs.forEach(c=>{
    const o=document.createElement('option'); o.value=c.name; o.textContent=c.name;
    manualCategory.appendChild(o);
  });
};

manualSaveBtn.onclick=()=>{
  if(!locationSelect.value) return showToast('Select location','warn');
  const cat=manualCategory.value;
  const sup=manualSupplier.value;
  const prod=manualProduct.value;
  const unit=manualUnit.value;
  const qty=parseInt(manualQty.value);
  if(!prod||!unit||isNaN(qty)) return;

  let c=data.catalogs.find(x=>x.name===cat);
  if(!c){c={name:cat, products:[]}; data.catalogs.push(c);}
  let p=c.products.find(x=>x.name===prod && x.supplier===sup);
  if(!p){p={name:prod, supplier:sup, packages:[]}; c.products.push(p);}
  let pkg=p.packages.find(x=>x.unit===unit);
  if(!pkg){pkg={unit, records:[]}; p.packages.push(pkg);}

  pkg.records.push({ qty, location: locationSelect.value, time:new Date().toISOString(), temp:true });

  localStorage.setItem('inventory', JSON.stringify(data));
  refresh();
  showToast('Manual saved');
};

/* Refresh product select & history */
function refresh(){
  // --- ÂàÜÁ±ª select ---
  const catSet = new Set();
  data.catalogs.forEach(c=>catSet.add(c.name));

  // catalogSelect
  catalogSelect.innerHTML='<option value="">All Categories</option>';
  [...catSet].forEach(cat=>{
    const o=document.createElement('option'); o.value=cat; o.textContent=cat;
    catalogSelect.appendChild(o);
  });

  // manualCategory
  manualCategory.innerHTML='';
  [...catSet].forEach(cat=>{
    const o=document.createElement('option'); o.value=cat; o.textContent=cat;
    manualCategory.appendChild(o);
  });

  // --- ‰∫ßÂìÅ select ---
  productSelect.innerHTML='<option value="">Select product</option>';
  const key = search.value.toLowerCase();
  const selectedCat = catalogSelect.value;
  data.catalogs.forEach((c,ci)=>{
    if(selectedCat && c.name !== selectedCat) return; // ËøáÊª§Á±ªÂà´
    c.products.forEach((p,pi)=>{
      if(key && !p.name.toLowerCase().includes(key)) return; // ËøáÊª§ÊêúÁ¥¢
      p.packages.forEach((pkg,ki)=>{
        const o=document.createElement('option');
        o.value=`${ci}-${pi}-${ki}`;
        o.textContent=`${p.supplier||'N/A'} | ${p.name} | ${pkg.unit}`;
        productSelect.appendChild(o);
      });
    });
  });

  updateHistory();
}{
  catalogSelect.innerHTML='<option value="">All Categories</option>';
  data.catalogs.forEach((c,ci)=>{
    const o=document.createElement('option'); o.value=c.name; o.textContent=c.name;
    catalogSelect.appendChild(o);
  });

  productSelect.innerHTML='<option value="">Select product</option>';
  data.catalogs.forEach((c,ci)=>c.products.forEach((p,pi)=>p.packages.forEach((pkg,ki)=>{
    const o=document.createElement('option');
    o.value=`${ci}-${pi}-${ki}`;
    o.textContent=`${p.supplier||'N/A'} | ${p.name} | ${pkg.unit}`;
    productSelect.appendChild(o);
  })));

  updateHistory();
}

/* Update history table */
function updateHistory(){
  let rows=[];
  data.catalogs.forEach(c=>c.products.forEach(p=>p.packages.forEach(pkg=>{
    pkg.records.forEach(r=>{
      rows.push({...r,c:c.name,p:p.name,s:p.supplier,u:pkg.unit});
    });
  })));
  rows.sort((a,b)=>new Date(b.time)-new Date(a.time));

  historyBody.innerHTML=rows.map(r=>`
    <tr>
      <td>${new Date(r.time).toLocaleString()}</td>
      <td>${r.location}</td>
      <td>${r.c}</td>
      <td>${r.s}</td>
      <td>${r.p}</td>
      <td>${r.u}</td>
      <td>${r.qty}</td>
      <td class="${r.temp?'temp-tag':''}">${r.temp?'Temporary':'Regular'}</td>
    </tr>
  `).join('');
}

/* CSV Import */
fileBtn.onclick = ()=>fileInput.click();
fileInput.onchange = ()=>{
  if(fileInput.files.length===0) return;
  const file=fileInput.files[0];
  fileName.textContent=file.name;
  const reader = new FileReader();
  reader.onload = e=>parseCSV(e.target.result);
  reader.readAsText(file);
};
function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2) return showToast('CSV empty','warn');
  const headers=lines[0].split(',').map(h=>h.trim());
  const idx = {
    category: headers.indexOf('Category'),
    supplier: headers.indexOf('Supplier'),
    product: headers.indexOf('Product'),
    unit: headers.indexOf('Unit')
  };
  if(Object.values(idx).some(i=>i<0)) return showToast('CSV header error','warn');

  data.catalogs=[];
  const catMap={};
  for(let i=1;i<lines.length;i++){
    const cells=lines[i].split(',').map(c=>c.trim());
    const cat=cells[idx.category]||'Uncategorized';
    const sup=cells[idx.supplier]||'';
    const prod=cells[idx.product]||'';
    const unit=cells[idx.unit]||'';

    if(!catMap[cat]){ catMap[cat]={name:cat,products:[]}; data.catalogs.push(catMap[cat]); }

    let p=catMap[cat].products.find(x=>x.name===prod && x.supplier===sup);
    if(!p){ p={name:prod,supplier:sup,packages:[]}; catMap[cat].products.push(p); }

    if(!p.packages.find(x=>x.unit===unit)) p.packages.push({unit,records:[]});
  }

  localStorage.setItem('inventory', JSON.stringify(data));
  refresh();
  showToast('CSV Loaded');
}

/* CSV Export */
exportBtn.onclick = ()=>{
  let rows=[['Time','Location','Category','Supplier','Product','Unit','Qty','Type']];
  data.catalogs.forEach(c=>c.products.forEach(p=>p.packages.forEach(pkg=>{
    pkg.records.forEach(r=>{
      rows.push([r.time,r.location,c.name,p.supplier,p.name,pkg.unit,r.qty,r.temp?'Temporary':'Regular']);
    });
  })));
  const csv=rows.map(r=>r.map(v=>`"${v??''}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const now=new Date();
  const pad=n=>n.toString().padStart(2,'0');
  const filename=`inventory_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.csv`;
  const a=document.createElement('a');
  a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
};

/* Search / filter */
search.oninput=refresh;
catalogSelect.onchange=refresh;

refresh();
</script>
</body>
</html>
