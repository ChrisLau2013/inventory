<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inventory Counting</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Inventory">

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; margin:0; }
header { background:#1e90ff; color:#fff; text-align:center; padding:14px; font-size:20px; position:sticky; top:0; }
main { padding:14px; }

input, select, button {
  width:100%; font-size:18px; padding:10px; margin-bottom:12px;
  border-radius:6px; box-sizing:border-box;
}

button { background:#1e90ff; color:#fff; border:none; }
button.secondary { background:#666; }

.hidden { display:none; }

.lock-btn { background:#ccc; color:#333; }
.lock-btn.locked { background:#28a745; color:#fff; }

#history { max-height:280px; overflow:auto; }
table { width:100%; border-collapse:collapse; font-size:13px; }
th,td { border:1px solid #ccc; padding:5px; text-align:center; }
thead th { position:sticky; top:0; background:#eee; }

.temp-tag { color:#ff5722; font-weight:600; }

#toast {
  position:fixed; bottom:30px; left:50%;
  transform:translateX(-50%); padding:14px 18px;
  border-radius:14px; background:#28a745;
  color:#fff; opacity:0; transition:.3s;
}
#toast.show { opacity:1; }
</style>
</head>

<body>

<header>Inventory Counting</header>

<main>

<button id="fileBtn">Choose CSV File</button>
<div id="fileName">No file chosen</div>
<input type="file" id="fileInput" accept=".csv" hidden>

<select id="locationSelect">
  <option value="">Select location</option>
  <option>Warehouse</option>
  <option>Loading Bay</option>
</select>

<button id="lockLocationBtn" class="lock-btn">üîì Location Unlocked</button>

<select id="catalogSelect"><option value="">All Categories</option></select>
<input id="search" placeholder="Search product">
<select id="productSelect"><option value="">Select product</option></select>

<input id="qtyInput" type="number" placeholder="Enter quantity">
<button id="saveBtn">Save Count</button>

<button class="secondary" id="manualBtn">‚ûï Manual Count</button>

<div id="manualPanel" class="hidden">
  <hr>
  <h3>Manual Entry (‰∏¥Êó∂)</h3>
  <select id="manualCategory"></select>
  <input id="manualSupplier" placeholder="Supplier">
  <input id="manualProduct" placeholder="Product">
  <input id="manualUnit" placeholder="Unit">
  <input id="manualQty" type="number" placeholder="Quantity">
  <button id="manualSaveBtn">Save Manual Count</button>
</div>

<hr>
<button class="secondary" id="exportBtn">Export CSV</button>

<div id="history">
<table>
<thead>
<tr>
  <th>Time</th>
  <th>Location</th>
  <th>Category</th>
  <th>Supplier</th>
  <th>Product</th>
  <th>Unit</th>
  <th>Qty</th>
  <th>Type</th>
</tr>
</thead>
<tbody id="historyBody"></tbody>
</table>
</div>

</main>

<div id="toast">Saved</div>

<script>
let data = JSON.parse(localStorage.getItem('inventory')) || { catalogs: [] };
const toast = document.getElementById('toast');

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),2000);
}

/* ---------- ELEMENTS ---------- */
const locationSelect = document.getElementById('locationSelect');
const lockBtn = document.getElementById('lockLocationBtn');
const productSelect = document.getElementById('productSelect');
const catalogSelect = document.getElementById('catalogSelect');
const search = document.getElementById('search');
const historyBody = document.getElementById('historyBody');

/* ---------- LOCATION LOCK ---------- */
let locationLocked=false;
lockBtn.onclick=()=>{
  locationLocked=!locationLocked;
  lockBtn.textContent = locationLocked ? 'üîí Location Locked' : 'üîì Location Unlocked';
  lockBtn.classList.toggle('locked',locationLocked);
};

/* ---------- SAVE NORMAL ---------- */
document.getElementById('saveBtn').onclick=()=>{
  if(!productSelect.value || !locationSelect.value) return showToast('Missing data');
  const qty=parseInt(qtyInput.value);
  if(isNaN(qty)) return;

  const [ci,pi,ki]=productSelect.value.split('-');
  data.catalogs[ci].products[pi].packages[ki].records.push({
    qty, location:locationSelect.value, time:new Date().toISOString()
  });

  localStorage.setItem('inventory',JSON.stringify(data));
  qtyInput.value='';
  if(!locationLocked) locationSelect.value='';
  refresh();
  showToast('Saved');
};

/* ---------- MANUAL ---------- */
manualBtn.onclick=()=>{
  manualPanel.classList.toggle('hidden');
  manualCategory.innerHTML='';
  data.catalogs.forEach(c=>{
    let o=document.createElement('option');
    o.value=c.name; o.textContent=c.name;
    manualCategory.appendChild(o);
  });
};

manualSaveBtn.onclick=()=>{
  if(!locationSelect.value) return showToast('Select location');

  const cat=manualCategory.value;
  const sup=manualSupplier.value;
  const prod=manualProduct.value;
  const unit=manualUnit.value;
  const qty=parseInt(manualQty.value);

  if(!prod||!unit||isNaN(qty)) return showToast('Incomplete');

  let catalog=data.catalogs.find(c=>c.name===cat);
  if(!catalog){ catalog={name:cat,products:[]}; data.catalogs.push(catalog); }

  let product=catalog.products.find(p=>p.name===prod&&p.supplier===sup);
  if(!product){
    product={name:prod,supplier:sup,packages:[]};
    catalog.products.push(product);
  }

  let pkg=product.packages.find(p=>p.unit===unit);
  if(!pkg){ pkg={unit,records:[]}; product.packages.push(pkg); }

  pkg.records.push({
    qty, location:locationSelect.value,
    time:new Date().toISOString(), temp:true
  });

  localStorage.setItem('inventory',JSON.stringify(data));
  refresh();
  showToast('Manual saved');
};

/* ---------- HISTORY ---------- */
function updateHistory(){
  historyBody.innerHTML='';
  let rows=[];
  data.catalogs.forEach(c=>c.products.forEach(p=>p.packages.forEach(pkg=>{
    pkg.records.forEach(r=>{
      rows.push({...r,c:c.name,p:p.name,s:p.supplier,u:pkg.unit});
    });
  })));
  rows.sort((a,b)=>new Date(b.time)-new Date(a.time));

  historyBody.innerHTML = rows.map(r=>`
    <tr>
      <td>${new Date(r.time).toLocaleString()}</td>
      <td>${r.location}</td>
      <td>${r.c}</td>
      <td>${r.s}</td>
      <td>${r.p}</td>
      <td>${r.u}</td>
      <td>${r.qty}</td>
      <td class="${r.temp?'temp-tag':''}">${r.temp?'‰∏¥Êó∂':'Ê≠£Âºè'}</td>
    </tr>
  `).join('');
}

/* ---------- PRODUCT LIST ---------- */
function refresh(){
  catalogSelect.innerHTML='<option value="">All Categories</option>';
  data.catalogs.forEach((c,i)=>{
    let o=document.createElement('option');
    o.value=c.name; o.textContent=c.name;
    catalogSelect.appendChild(o);
  });

  productSelect.innerHTML='<option value="">Select product</option>';
  data.catalogs.forEach((c,ci)=>c.products.forEach((p,pi)=>p.packages.forEach((pkg,ki)=>{
    let o=document.createElement('option');
    o.value=`${ci}-${pi}-${ki}`;
    o.textContent=`${p.supplier||''} | ${p.name} | ${pkg.unit}`;
    productSelect.appendChild(o);
  })));

  updateHistory();
}

refresh();
</script>

</body>
</html>
