<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inventory Counting</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="apple-touch-icon" sizes="180x180" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Inventory">

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:0;
  padding:0;
}
header {
  background:#1e90ff;
  color:#fff;
  text-align:center;
  padding:14px;
  font-size:20px;
  position:sticky;
  top:0;
}
main { padding:14px; }

input, select, button {
  width:100%;
  font-size:18px;
  padding:10px;
  margin-bottom:12px;
  border-radius:6px;
  box-sizing:border-box;
}

button {
  background:#1e90ff;
  color:#fff;
  border:none;
}
button.secondary { background:#666; }

.hidden { display:none; }

#info { font-size:14px; margin-bottom:12px; }

#history {
  max-height:260px;
  overflow:auto;
  border-top:1px solid #ccc;
}
table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td {
  border:1px solid #ccc;
  padding:5px;
  text-align:center;
}
thead th {
  position:sticky;
  top:0;
  background:#eee;
}

/* Location */
.location-row {
  margin-bottom:12px;
}

/* Lock Button */
.lock-btn {
  width:100%;
  font-size:16px;
  padding:12px;
  border-radius:8px;
  background:#ccc;
  color:#333;
}
.lock-btn.locked {
  background:#28a745;
  color:#fff;
}
.lock-btn.disabled {
  background:#ddd;
  color:#777;
}

/* Toast */
#toast {
  position:fixed;
  bottom:28px;
  left:50%;
  transform:translateX(-50%) translateY(20px);
  padding:14px 18px;
  border-radius:14px;
  font-size:15px;
  color:#fff;
  opacity:0;
  pointer-events:none;
  transition:.35s;
}
#toast.show {
  opacity:1;
  transform:translateX(-50%) translateY(0);
}
#toast.success { background:#28a745; }
#toast.warn { background:#ff9800; }
</style>
</head>

<body>

<header>Inventory Counting</header>

<main>

<!-- CSV æ–‡ä»¶é€‰æ‹© -->
<button id="fileBtn">Choose CSV File</button>
<div id="fileName">No file chosen</div>
<input type="file" id="fileInput" accept=".csv" hidden>

<!-- Location -->
<div class="location-row">
  <select id="locationSelect">
    <option value="">Select location</option>
    <option>Warehouse Shifts near loading bay</option>
    <option>Warehouse Shifts near Boiler</option>
    <option>Warehouse Shifts close cooler wall</option>
    <option>Warehouse Middle Shifts</option>
    <option>Warehouse Shifts at flour mixer room hallway</option>
    <option>Loading Bay 1</option>
    <option>Loading Bay 2</option>
    <option>Loading Bay 3</option>
    <option>Loading Bay 4</option>
    <option>Loading Bay 5</option>
    <option>Loading Bay 6</option>
  </select>
</div>

<button type="button" id="lockLocationBtn" class="lock-btn disabled">
  ðŸ”“ Location Unlocked
</button>

<!-- åˆ†ç±»ç­›é€‰ã€æœç´¢ã€äº§å“é€‰æ‹© -->
<select id="catalogSelect">
  <option value="">All Categories</option>
</select>

<input id="search" placeholder="Search product">

<select id="productSelect">
  <option value="">Select product</option>
</select>

<div id="info"></div>

<input id="qtyInput" type="number" inputmode="numeric" placeholder="Enter quantity">
<button id="saveBtn">Save Count</button>

<hr>
<button class="secondary" id="exportBtn">Export CSV</button>

<div id="history">
  <h3>Counting History</h3>
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Category</th>
        <th>Supplier</th>
        <th>Product</th>
        <th>Unit</th>
        <th>Location</th>
        <th>Qty</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

</main>

<div id="toast" class="success">Saved</div>

<script>
/* ---------- HAPTIC ---------- */
function haptic(type='light'){
  if(!navigator.vibrate) return;
  navigator.vibrate(type==='medium'?20:10);
}

/* ---------- DATA ---------- */
let data = JSON.parse(localStorage.getItem('inventory')) || { catalogs: [] };
let locationLocked = false;

/* ---------- ELEMENTS ---------- */
const locationSelect = document.getElementById('locationSelect');
const lockBtn = document.getElementById('lockLocationBtn');
const qtyInput = document.getElementById('qtyInput');
const historyBody = document.getElementById('historyBody');
const productSelect = document.getElementById('productSelect');
const catalogSelect = document.getElementById('catalogSelect');
const search = document.getElementById('search');

const fileBtn = document.getElementById('fileBtn');
const fileInput = document.getElementById('fileInput');
const fileName = document.getElementById('fileName');
const exportBtn = document.getElementById('exportBtn');

/* ---------- TOAST ---------- */
function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className=type+' show';
  setTimeout(()=>t.classList.remove('show'),2000);
}

/* ---------- LOCATION LOCK ---------- */
locationSelect.addEventListener('change',()=>{
  if(locationSelect.value){
    lockBtn.classList.remove('disabled');
  }else{
    locationLocked=false;
    lockBtn.className='lock-btn disabled';
    lockBtn.textContent='ðŸ”“ Location Unlocked';
  }
});

lockBtn.onclick=()=>{
  if(!locationSelect.value) return;
  locationLocked=!locationLocked;
  lockBtn.className='lock-btn'+(locationLocked?' locked':'');
  lockBtn.textContent=locationLocked
    ? 'ðŸ”’ Location Locked'
    : 'ðŸ”“ Location Unlocked';
  haptic(locationLocked?'medium':'light');
};

/* ---------- SAVE ---------- */
document.getElementById('saveBtn').onclick=()=>{
  if(!productSelect.value) return showToast('Select product','warn');
  if(!locationSelect.value) return showToast('Select location','warn');
  const qty=parseInt(qtyInput.value);
  if(isNaN(qty)) return showToast('Enter quantity','warn');

  const [ci,pi,ki]=productSelect.value.split('-');
  data.catalogs[ci].products[pi].packages[ki].records.push({
    qty,
    location:locationSelect.value,
    time:new Date().toISOString()
  });

  localStorage.setItem('inventory',JSON.stringify(data));
  refresh();
  qtyInput.value='';
  if(!locationLocked) locationSelect.value='';
  haptic('light');
  showToast('Saved');
};

/* ---------- PRODUCT LOGIC ---------- */
function refresh(){
  catalogSelect.innerHTML='<option value="">All Categories</option>';
  data.catalogs.forEach((c,ci)=>{
    const o=document.createElement('option');
    o.value=c.name;
    o.textContent=c.name;
    catalogSelect.appendChild(o);
  });
  buildProductSelect();
  updateHistory();
}

function buildProductSelect(){
  productSelect.innerHTML='<option value="">Select product</option>';
  const key=search.value.toLowerCase();
  const selectedCat=catalogSelect.value;
  data.catalogs.forEach((c,ci)=>{
    if(selectedCat && c.name!==selectedCat) return;
    c.products.forEach((p,pi)=>{
      if(key && !p.name.toLowerCase().includes(key)) return;
      p.packages.forEach((pkg,ki)=>{
        const o=document.createElement('option');
        o.value=`${ci}-${pi}-${ki}`;
        o.textContent=`${p.supplier||'N/A'} | ${p.name} | ${pkg.unit}`;
        productSelect.appendChild(o);
      });
    });
  });
}

function updateHistory(){
  historyBody.innerHTML='';
  let rows=[];
  data.catalogs.forEach(c=>c.products.forEach(p=>p.packages.forEach(pkg=>{
    pkg.records.forEach(r=>{
      rows.push({
        t:new Date(r.time),
        ...r,
        c:c.name,
        p:p.name,
        u:pkg.unit,
        s:p.supplier
      });
    });
  })));
  rows.sort((a,b)=>b.t-a.t);
  let html = rows.map(r=>`
      <tr>
        <td>${new Date(r.time).toLocaleString()}</td>
        <td>${r.c}</td>
        <td>${r.s}</td>
        <td>${r.p}</td>
        <td>${r.u}</td>
        <td>${r.location}</td>
        <td>${r.qty}</td>
      </tr>`).join('');
  historyBody.innerHTML = html;
}

/* ---------- CSV IMPORT ---------- */
fileBtn.addEventListener('click',()=>fileInput.click());

fileInput.addEventListener('change',()=>{
  if(fileInput.files.length===0) return;
  const file = fileInput.files[0];
  fileName.textContent = file.name;

  const reader = new FileReader();
  reader.onload = e=>{
    const text = e.target.result;
    parseCSV(text);

    // ç¦ç”¨æŒ‰é’®
    fileBtn.disabled = true;
    fileBtn.style.background = '#ccc';
  };
  reader.readAsText(file);
});

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2) return showToast('CSV is empty','warn');

  const headers = lines[0].split(',').map(h=>h.trim());
  const idx = {
    category: headers.indexOf('Category'),
    supplier: headers.indexOf('Supplier'),
    product: headers.indexOf('Product'),
    unit: headers.indexOf('Unit')
  };
  if(Object.values(idx).some(i=>i<0)) return showToast('CSV headers must include Category,Supplier,Product,Unit','warn');

  data.catalogs = [];
  const catMap = {};

  for(let i=1;i<lines.length;i++){
    const cells = lines[i].split(',').map(c=>c.trim());
    const cat = cells[idx.category] || 'Uncategorized';
    const sup = cells[idx.supplier] || '';
    const prod = cells[idx.product] || '';
    const unit = cells[idx.unit] || '';

    if(!catMap[cat]){
      catMap[cat] = { name: cat, products: [] };
      data.catalogs.push(catMap[cat]);
    }
    let productObj = catMap[cat].products.find(p=>p.name===prod && p.supplier===sup);
    if(!productObj){
      productObj = { name: prod, supplier: sup, packages: [{ unit, records: [] }] };
      catMap[cat].products.push(productObj);
    } else {
      if(!productObj.packages.find(pkg=>pkg.unit===unit)){
        productObj.packages.push({ unit, records: [] });
      }
    }
  }

  localStorage.setItem('inventory',JSON.stringify(data));
  refresh();
  showToast('CSV Loaded');
}

/* ---------- CSV EXPORT ---------- */
exportBtn.addEventListener('click', ()=>{
  let rows = [['Time','Category','Supplier','Product','Unit','Location','Qty']];
  data.catalogs.forEach(c=>c.products.forEach(p=>p.packages.forEach(pkg=>{
    pkg.records.forEach(r=>{
      rows.push([
        r.time,
        c.name,
        p.supplier,
        p.name,
        pkg.unit,
        r.location,
        r.qty
      ]);
    });
  })));

  const csv = rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);

  const now = new Date();
  const pad = n => n.toString().padStart(2,'0');
  const filename = `inventory_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.csv`;

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
});

search.addEventListener('input',buildProductSelect);
catalogSelect.addEventListener('change',buildProductSelect);

refresh();
</script>

</body>
</html>
