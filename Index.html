<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inventory Counting (iPhone Safe)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  margin:0; padding:0;
}
header {
  background:#1e90ff;
  color:#fff;
  text-align:center;
  padding:14px;
  font-size:20px;
  position:sticky;
  top:0;
}
main { padding:14px; }

input, select, button {
  width:100%;
  font-size:18px;
  padding:10px;
  margin-bottom:12px;
  border-radius:6px;
  box-sizing:border-box;
}

button { background:#1e90ff; color:#fff; border:none; }
button.secondary { background:#666; }

.hidden { display:none; }

#info { font-size:14px; margin-bottom:12px; }

#status {
  font-size:14px;
  padding:8px;
  background:#f0f0f0;
  border-radius:6px;
  margin-bottom:12px;
}

#history {
  max-height:260px;
  overflow:auto;
  border-top:1px solid #ccc;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td {
  border:1px solid #ccc;
  padding:5px;
  text-align:center;
}
thead th {
  position:sticky;
  top:0;
  background:#eee;
}
</style>
</head>

<body>

<header>Inventory Counting (iPhone)</header>

<main>

<div id="status">ðŸ“‚ å°šæœªè¼‰å…¥ CSV</div>

<input type="file" id="fileInput" accept=".csv">

<select id="catalogSelect" onchange="buildProductSelect()">
  <option value="">All Categories</option>
</select>

<input id="search" placeholder="Search product" oninput="buildProductSelect()">

<select id="productSelect" onchange="showInfo()">
  <option value="">Select product</option>
</select>

<div id="info"></div>

<input id="qtyInput" type="number" inputmode="numeric" placeholder="Enter quantity">
<button onclick="saveSelected()">Save Count</button>

<hr>
<button class="secondary" onclick="exportCSV()">Export CSV</button>
<button class="secondary" onclick="clearAll()">Clear All Data</button>

<div id="history">
<h3>Counting History</h3>
<table>
<thead>
<tr>
<th>Time</th><th>Category</th><th>Supplier</th>
<th>Product</th><th>Unit</th><th>Qty</th>
</tr>
</thead>
<tbody id="historyBody"></tbody>
</table>
</div>

</main>

<script>
/* ===== CSV parser (iOS safe) ===== */
function parseCSVLine(line){
  const result = [];
  let current = '';
  let inQuotes = false;

  for(let c of line){
    if(c === '"') inQuotes = !inQuotes;
    else if(c === ',' && !inQuotes){
      result.push(current); current='';
    } else current += c;
  }
  result.push(current);
  return result.map(v => v.trim().replace(/^"|"$/g,''));
}

/* ===== Data ===== */
let data;
try {
  data = JSON.parse(localStorage.getItem('inventory')) || { catalogs: [] };
} catch {
  data = { catalogs: [] };
}

/* ===== Elements ===== */
const fileInput = document.getElementById('fileInput');
const catalogSelect = document.getElementById('catalogSelect');
const productSelect = document.getElementById('productSelect');
const search = document.getElementById('search');
const qtyInput = document.getElementById('qtyInput');
const info = document.getElementById('info');
const historyBody = document.getElementById('historyBody');
const statusBox = document.getElementById('status');

let csvLoaded = false;

/* ===== File Input ===== */
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  fileInput.value = '';
  if(!file) return;
  importCSV(file);
});

/* ===== Import CSV ===== */
function importCSV(file){
  const reader = new FileReader();
  reader.onload = e => {
    let text = e.target.result;
    if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);

    const lines = text.split(/\r?\n/).filter(l=>l.trim());
    if(lines.length < 2){
      alert('CSV æ ¼å¼éŒ¯èª¤');
      return;
    }

    const headers = parseCSVLine(lines[0]).map(h=>h.toLowerCase());
    const rows = lines.slice(1).map(l=>{
      const v = parseCSVLine(l);
      const o = {};
      headers.forEach((h,i)=>o[h]=v[i]||'');
      return o;
    });

    rows.forEach(r=>{
      addProduct(
        r.category || 'Default',
        r.product || '',
        r.unit || '',
        r.supplier || ''
      );
    });

    save();
    refresh();
    csvLoaded = true;
    statusBox.textContent = `âœ… CSV å·²è¼‰å…¥ï¼ˆ${rows.length} ç­†ï¼‰`;
    alert('CSV è¼‰å…¥æˆåŠŸ');
  };
  reader.readAsText(file);
}

/* ===== Core ===== */
function addProduct(cat,prod,unit,sup){
  if(!prod || !unit) return;
  let c = data.catalogs.find(x=>x.name===cat);
  if(!c){ c={name:cat,products:[]}; data.catalogs.push(c); }
  let p = c.products.find(x=>x.name===prod && x.supplier===sup);
  if(!p){ p={name:prod,supplier:sup,packages:[]}; c.products.push(p); }
  if(!p.packages.find(x=>x.unit===unit))
    p.packages.push({unit,records:[]});
}

function save(){
  localStorage.setItem('inventory', JSON.stringify(data));
}

function refresh(){
  catalogSelect.innerHTML='<option value="">All Categories</option>';
  data.catalogs.forEach(c=>{
    const o=document.createElement('option');
    o.value=c.name; o.textContent=c.name;
    catalogSelect.appendChild(o);
  });
  buildProductSelect();
  updateHistory();
}

function buildProductSelect(){
  productSelect.innerHTML='<option value="">Select product</option>';
  const key=search.value.toLowerCase();
  data.catalogs.forEach((c,ci)=>{
    c.products.forEach((p,pi)=>{
      if(key && !p.name.toLowerCase().includes(key)) return;
      p.packages.forEach((pkg,ki)=>{
        productSelect.innerHTML+=
        `<option value="${ci}-${pi}-${ki}">
          ${p.supplier} | ${p.name} | ${pkg.unit}
        </option>`;
      });
    });
  });
}

function showInfo(){
  if(!productSelect.value){ info.textContent=''; return; }
  const [ci,pi,ki]=productSelect.value.split('-');
  const r=data.catalogs[ci].products[pi].packages[ki].records.at(-1);
  info.textContent = r ? `Last: ${r.qty} (${r.time})` : 'No record';
}

function saveSelected(){
  if(!productSelect.value) return alert('è«‹é¸æ“‡ç”¢å“');
  const qty=parseInt(qtyInput.value);
  if(isNaN(qty)) return alert('è«‹è¼¸å…¥æ•¸é‡');
  const [ci,pi,ki]=productSelect.value.split('-');
  data.catalogs[ci].products[pi].packages[ki].records.push({
    qty,time:new Date().toLocaleString()
  });
  save(); refresh(); qtyInput.value='';
}

function updateHistory(){
  historyBody.innerHTML='';
  let rows=[];
  data.catalogs.forEach(c=>c.products.forEach(p=>p.packages.forEach(pkg=>{
    pkg.records.forEach(r=>{
      rows.push({t:new Date(r.time),...r,c:c.name,p:p.name,u:pkg.unit,s:p.supplier});
    });
  })));
  rows.sort((a,b)=>b.t-a.t);
  rows.forEach(r=>{
    historyBody.innerHTML+=
      `<tr><td>${r.time}</td><td>${r.c}</td><td>${r.s}</td>
       <td>${r.p}</td><td>${r.u}</td><td>${r.qty}</td></tr>`;
  });
}

function exportCSV(){
  let csv='time,category,supplier,product,unit,qty\n';
  data.catalogs.forEach(c=>c.products.forEach(p=>p.packages.forEach(pkg=>{
    pkg.records.forEach(r=>{
      csv+=`${r.time},${c.name},${p.supplier},${p.name},${pkg.unit},${r.qty}\n`;
    });
  })));
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download='inventory.csv';
  a.click();
}

function clearAll(){
  if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')){
    localStorage.clear();
    location.reload();
  }
}

refresh();
</script>

</body>
</html>
